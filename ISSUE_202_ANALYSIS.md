# Issue #202 分析 - 基础策略做空偏好问题

## 问题描述
**用户反馈**: "基础策略有很严重的空头喜好倾向，需要修改一部分代码和参数。改完以后判断就正常了。目前盈利"

**根本原因**: "在engine.go里面修改prompt，初始prompt引导ai做空偏多"

---

## 业务逻辑分析

### 1. **AI 决策流程架构**

```
获取市场数据 → 构建 System Prompt → 构建 User Prompt → 调用 AI API → 解析决策 → 验证决策 → 执行交易
```

**文件位置**: `decision/engine.go`

#### 核心函数链：
- `GetFullDecision()` - 主入口（第93行）
  - `fetchMarketDataForContext()` - 获取市场数据（第121行）
  - `buildSystemPrompt()` - 构建固定规则提示词（第203行）
  - `buildUserPrompt()` - 构建动态数据提示词（第319行）
  - `mcpClient.CallWithMessages()` - 调用AI API
  - `parseFullDecisionResponse()` - 解析AI响应（第420行）
  - `validateDecisions()` - 验证决策合理性（第502行）

---

### 2. **System Prompt 中的做空相关设置（第203-316行）**

#### **关键部分 1：做多做空平衡（第229-235行）**

```go
// === 做空激励 ===
sb.WriteString("# 📉 做多做空平衡\n\n")
sb.WriteString("**重要**: 下跌趋势做空的利润 = 上涨趋势做多的利润\n\n")
sb.WriteString("- 上涨趋势 → 做多\n")
sb.WriteString("- 下跌趋势 → 做空\n")
sb.WriteString("- 震荡市场 → 观望\n\n")
sb.WriteString("**不要有做多偏见！做空是你的核心工具之一**\n\n")
```

**问题所在**: 这段文字的措辞虽然平衡，但标题"做空激励"和最后一句"**不要有做多偏见！做空是你的核心工具之一**"可能会误导AI过度执行做空。

#### **关键部分 2：输出示例（第298-301行）**

```go
// 示例中首先展示做空
fmt.Sprintf("  {\\\"symbol\\\": \\\"BTCUSDT\\\", \\\"action\\\": \\\"open_short\\\", ..."),
// 然后才是平多
sb.WriteString("  {\\\"symbol\\\": \\\"ETHUSDT\\\", \\\"action\\\": \\\"close_long\\\", ...")
```

**问题所在**: JSON 示例中把 `open_short` 放在 `close_long` 之前，这可能强化 AI 对做空的优先级偏好。

---

### 3. **决策验证逻辑（第534-622行）**

#### **风险回报比强制约束**

```go
// 第615-619行
// 硬约束：风险回报比必须≥3.0
if riskRewardRatio < 3.0 {
    return fmt.Errorf("风险回报比过低(%.2f:1)，必须≥3.0:1 ...")
}
```

**做多 vs 做空计算差异**（第579-620行）：

**做多时**（第579-582行）：
```go
if d.Action == "open_long" {
    if d.StopLoss >= d.TakeProfit {
        return fmt.Errorf("做多时止损价必须小于止盈价")
    }
}
```
- 止损价 < 止盈价
- 计算方法：`entryPrice = StopLoss + (TakeProfit - StopLoss) * 0.2`（在20%位置入场）

**做空时**（第584-587行）：
```go
} else {
    if d.StopLoss <= d.TakeProfit {
        return fmt.Errorf("做空时止损价必须大于止盈价")
    }
}
```
- 止损价 > 止盈价
- 计算方法：`entryPrice = StopLoss - (StopLoss - TakeProfit) * 0.2`（在20%位置入场）

**潜在问题**: 做空时的止损/止盈逻辑与做多相反，在风险计算上可能存在不对称的参数敏感性。

---

### 4. **市场数据和账户信息流**

#### User Prompt 构成（第319-416行）：

1. **时间周期信息**（第323-324行）
2. **BTC 市场数据**（第327-331行）- 作为趋势参考
3. **账户状态**（第334-340行）
4. **当前持仓详情**（第343-370行）
5. **候选币种**（第376-396行） - 完整市场数据
6. **夏普比率**（第400-411行）- 历史性能反馈

---

## 根本问题诊断

### **假设 1: Prompt 措辞偏向做空**
- System Prompt 中对做空的强调可能过度
- 示例顺序可能造成偏好

### **假设 2: 风险计算不对称**
- 做多和做空的风险回报比计算方式不同
- 实际风险的数学模型可能更利于做空信号通过验证

### **假设 3: AI 模型本身偏好**
- 某些 AI 模型（Qwen/DeepSeek）可能对做空信号更敏感
- 特别是当面临"回避交易"与"积极做空"的选择时

---

## 修复方案

### **方案 A: 修改 System Prompt（推荐）**

**文件**: `decision/engine.go` 第203-316 行

1. **调整第229-235行的措辞**：
   - 改为中性表述，避免"做空激励"的强调
   - 确保做多做空的表述对称

2. **调整第298-301行的示例顺序**：
   - 将 `open_long` 示例放在 `open_short` 之前
   - 或完全分离示例，不体现顺序偏好

3. **添加做多相关的强调**：
   - 补充"上涨趋势做多是最可靠的信号"类似表述

### **方案 B: 修改风险计算（进阶）**

**文件**: `decision/engine.go` 第534-622 行

- 检查做多和做空的风险回报比计算是否真正对称
- 可能需要添加测试用例验证两种情况的风险计算结果

### **方案 C: 添加做空限制（保守）**

在 `validateDecision` 中添加额外约束：
- 做空时要求信心度更高（如 ≥ 85 vs 做多 ≥ 75）
- 做空单笔仓位上限（如最多账户净值的 5x）

---

## 关键业务逻辑总结

| 维度 | 做多 | 做空 | 备注 |
|------|------|------|------|
| **止损止盈关系** | SL < TP | SL > TP | 反向逻辑 |
| **入场价计算** | SL + 20% | SL - 20% | 不对称 |
| **风险回报比** | (TP-EP)/(EP-SL) | (EP-TP)/(SL-EP) | 分子分母不同 |
| **System Prompt** | 被动提及 | 主动强调 | 🔴 问题所在 |
| **示例顺序** | 后 | 先 | 🔴 可能的偏好 |

---

## 建议优先级

1. **✅ 立即修改**: System Prompt 措辞（方案 A）- 可能有 80% 概率解决问题
2. **🔄 验证**: 数学上的风险回报比计算对称性（方案 B）
3. **📊 监控**: 修改后的做空/做多交易比例（添加日志统计）
