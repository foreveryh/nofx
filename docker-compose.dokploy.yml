# docker-compose.dokploy.yml - Dokploy + Traefik 完整配置
# 支持: Backend (API) + Frontend (Static) + Init (Fix config.json)
# 不需要 Nginx proxy，前端直接调用 Backend API

services:
  # ============================================================
  # 初始化服务：修复 config.json 和 beta_codes.txt
  # ============================================================
  init:
    image: alpine:latest
    container_name: nofx-init
    volumes:
      - ./config.json:/data/config.json
      - ./beta_codes.txt:/data/beta_codes.txt
      - ./secrets:/data/secrets
      - ./decision_logs:/data/decision_logs
    working_dir: /data
    command:
      - /bin/sh
      - -c
      - |
        set -e
        echo 'Initializing required files...'

        CONFIG_MOUNT_PATH='config.json'
        CONFIG_TARGET_PATH="$$CONFIG_MOUNT_PATH"
        CONFIG_FORCE_GENERATE=false
        if [ -d "$$CONFIG_MOUNT_PATH" ]; then
          echo 'config.json mount is a directory, writing config.json/config.json'
          CONFIG_TARGET_PATH="$$CONFIG_MOUNT_PATH/config.json"
          CONFIG_FORCE_GENERATE=true
        fi
        mkdir -p "$(dirname "$$CONFIG_TARGET_PATH")"
        if [ "$$CONFIG_FORCE_GENERATE" = "true" ] || [ ! -f "$$CONFIG_TARGET_PATH" ]; then
          echo 'Creating config.json file'
          printf '%s\n' '{' '  "admin_mode": true,' '  "registration_enabled": false,' '  "jwt_secret": "default_jwt_for_testing",' '  "database_path": "config.db",' '  "server_port": 8080,' '  "log_level": "info"' '}' > "$$CONFIG_TARGET_PATH"
        fi

        BETA_MOUNT_PATH='beta_codes.txt'
        BETA_TARGET_PATH="$$BETA_MOUNT_PATH"
        BETA_FORCE_GENERATE=false
        if [ -d "$$BETA_MOUNT_PATH" ]; then
          echo 'beta_codes.txt mount is a directory, writing beta_codes.txt/beta_codes.txt'
          BETA_TARGET_PATH="$$BETA_MOUNT_PATH/beta_codes.txt"
          BETA_FORCE_GENERATE=true
        fi
        mkdir -p "$(dirname "$$BETA_TARGET_PATH")"
        if [ "$$BETA_FORCE_GENERATE" = "true" ] || [ ! -f "$$BETA_TARGET_PATH" ]; then
          echo 'Creating beta_codes.txt'
          touch "$$BETA_TARGET_PATH"
        fi

        if [ ! -d secrets ]; then
          echo 'Creating secrets directory'
          mkdir -p secrets
          chmod 700 secrets
        fi

        if [ ! -d decision_logs ]; then
          echo 'Creating decision_logs directory'
          mkdir -p decision_logs
        fi

        echo 'Initialization complete'
    networks:
      - nofx-network
    restart: "no"

  # ============================================================
  # Backend 服务：API 和交易逻辑
  # ============================================================
  nofx:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.backend
    container_name: nofx-trading
    restart: unless-stopped
    stop_grace_period: 30s
    depends_on:
      init:
        condition: service_completed_successfully
    # Dokploy 会处理端口映射，不需要在这里定义
    # ports:
    #   - "8080:8080"
    volumes:
      - ./config.json:/app/config.json:ro
      - ./config.db:/app/config.db
      - ./beta_codes.txt:/app/beta_codes.txt:ro
      - ./decision_logs:/app/decision_logs
      - ./prompts:/app/prompts
      - ./secrets:/app/secrets
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=${NOFX_TIMEZONE:-Asia/Shanghai}
      - AI_MAX_TOKENS=4000
      - DATA_ENCRYPTION_KEY=${DATA_ENCRYPTION_KEY}
      - JWT_SECRET=${JWT_SECRET:-default_jwt_secret_for_testing}
      # AI Model Configuration
      - CUSTOM_AI_ENDPOINT=${CUSTOM_AI_ENDPOINT:-https://openrouter.ai/api/v1#}
      - CUSTOM_AI_API_KEY=${CUSTOM_AI_API_KEY}
      - CUSTOM_AI_MODEL=${CUSTOM_AI_MODEL:-anthropic/claude-3.5-sonnet}
      # Binance Exchange
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_SECRET_KEY=${BINANCE_SECRET_KEY}
      - BINANCE_TESTNET=${BINANCE_TESTNET:-false}
      - BINANCE_FUTURES=${BINANCE_FUTURES:-true}
      - BTC_ETH_LEVERAGE=${BTC_ETH_LEVERAGE:-5}
      - ALTCOIN_LEVERAGE=${ALTCOIN_LEVERAGE:-5}
      # Risk Management
      - MAX_DAILY_LOSS=${MAX_DAILY_LOSS:-10.0}
      - MAX_DRAWDOWN=${MAX_DRAWDOWN:-20.0}
      - STOP_TRADING_MINUTES=${STOP_TRADING_MINUTES:-60}
      # Default Coins
      - USE_DEFAULT_COINS=${USE_DEFAULT_COINS:-true}
      - DEFAULT_COINS=${DEFAULT_COINS:-BTCUSDT,ETHUSDT,SOLUSDT,BNBUSDT,XRPUSDT,DOGEUSDT,ADAUSDT,HYPEUSDT}
      # Notifications
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      # System
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30}
      - HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-10}
      - API_TIMEOUT=${API_TIMEOUT:-30s}
      - WEBSOCKET_TIMEOUT=${WEBSOCKET_TIMEOUT:-60s}
    networks:
      - nofx-network
      - dokploy-network
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1:8080/api/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.private-nofx-izy0el-2-api.rule=Host(`api.nofx.deeptoai.com`)
      - traefik.http.routers.private-nofx-izy0el-2-api.entrypoints=web
      - traefik.http.services.private-nofx-izy0el-2-api.loadbalancer.server.port=8080
      - traefik.http.routers.private-nofx-izy0el-2-api.service=private-nofx-izy0el-2-api
      - traefik.http.routers.private-nofx-izy0el-2-api.middlewares=redirect-to-https@file
      - traefik.http.routers.private-nofx-izy0el-2-apisecure.rule=Host(`api.nofx.deeptoai.com`)
      - traefik.http.routers.private-nofx-izy0el-2-apisecure.entrypoints=websecure
      - traefik.http.services.private-nofx-izy0el-2-apisecure.loadbalancer.server.port=8080
      - traefik.http.routers.private-nofx-izy0el-2-apisecure.service=private-nofx-izy0el-2-apisecure
      - traefik.http.routers.private-nofx-izy0el-2-apisecure.tls.certresolver=letsencrypt

  # ============================================================
  # Frontend 服务：静态文件（无 Nginx proxy）
  # ============================================================
  nofx-frontend:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.frontend
    container_name: nofx-frontend
    restart: unless-stopped
    # NO PORTS - Dokploy handles this via Traefik
    # ports:
    #   - "${NOFX_FRONTEND_PORT:-3000}:80"
    volumes:
      - ./nginx/nginx.static.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://api.nofx.deeptoai.com/api}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-wss://api.nofx.deeptoai.com/ws}
      - NEXT_PUBLIC_DOMAIN=${NEXT_PUBLIC_DOMAIN:-localhost}
    networks:
      - nofx-network
      - dokploy-network
    depends_on:
      - nofx
    healthcheck:
      test:
        - CMD
        - wget
        - --no-verbose
        - --tries=1
        - --spider
        - http://127.0.0.1/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.private-nofx-izy0el-2-web.rule=Host(`nofx.deeptoai.com`)
      - traefik.http.routers.private-nofx-izy0el-2-web.entrypoints=web
      - traefik.http.services.private-nofx-izy0el-2-web.loadbalancer.server.port=80
      - traefik.http.routers.private-nofx-izy0el-2-web.middlewares=redirect-to-https@file
      - traefik.http.routers.private-nofx-izy0el-2-websecure.rule=Host(`nofx.deeptoai.com`)
      - traefik.http.routers.private-nofx-izy0el-2-websecure.entrypoints=websecure
      - traefik.http.services.private-nofx-izy0el-2-websecure.loadbalancer.server.port=80
      - traefik.http.routers.private-nofx-izy0el-2-websecure.tls.certresolver=letsencrypt

networks:
  nofx-network:
    driver: bridge


volumes:
  # Redis 缓存（可选，用于会话共享）
  redis_data:
    driver: local
