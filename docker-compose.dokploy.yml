# docker-compose.dokploy.yml - Dokploy + Traefik å®Œæ•´é…ç½®
# æ”¯æŒ: Backend (API) + Frontend (Static) + Init (Fix config.json)
# ä¸éœ€è¦ Nginx proxyï¼Œå‰ç«¯ç›´æŽ¥è°ƒç”¨ Backend API

services:
  # ============================================================
  # åˆå§‹åŒ–æœåŠ¡ï¼šä¿®å¤ config.json å’Œ beta_codes.txt
  # ============================================================
  init:
    image: alpine:latest
    container_name: nofx-init
    volumes:
      - ./config.json:/data/config.json
      - ./beta_codes.txt:/data/beta_codes.txt
      - ./secrets:/data/secrets
      - ./decision_logs:/data/decision_logs
    working_dir: /data
    command: |
      sh -c "
        echo 'ðŸ”„ Initializing required files...'

        # Fix config.json directory issue
        if [ -d config.json ]; then
          echo 'âŒ Removing config.json directory (Docker bug)'
          rm -rf config.json
        fi
        if [ ! -f config.json ]; then
          echo 'âœ… Creating config.json file'
          cat > config.json << 'EOF'
{
  \"admin_mode\": true,
  \"registration_enabled\": false,
  \"jwt_secret\": \"default_jwt_for_testing\",
  \"database_path\": \"config.db\",
  \"server_port\": 8080,
  \"log_level\": \"info\"
}
EOF
        fi

        # Fix beta_codes.txt
        if [ -d beta_codes.txt ]; then
          rm -rf beta_codes.txt
        fi
        if [ ! -f beta_codes.txt ]; then
          echo 'âœ… Creating beta_codes.txt'
          touch beta_codes.txt
        fi

        # Ensure secrets directory
        if [ ! -d secrets ]; then
          echo 'âœ… Creating secrets directory'
          mkdir -p secrets
          chmod 700 secrets
        fi

        # Ensure decision_logs directory
        if [ ! -d decision_logs ]; then
          echo 'âœ… Creating decision_logs directory'
          mkdir -p decision_logs
        fi

        echo 'âœ… Initialization complete'
      "
    networks:
      - nofx-network
    restart: "no"

  # ============================================================
  # Backend æœåŠ¡ï¼šAPI å’Œäº¤æ˜“é€»è¾‘
  # ============================================================
  nofx:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.backend
    container_name: nofx-trading
    restart: unless-stopped
    stop_grace_period: 30s
    depends_on:
      init:
        condition: service_completed_successfully
    # Dokploy ä¼šå¤„ç†ç«¯å£æ˜ å°„ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œå®šä¹‰
    # ports:
    #   - "8080:8080"
    volumes:
      - ./config.json:/app/config.json:ro
      - ./config.db:/app/config.db
      - ./beta_codes.txt:/app/beta_codes.txt:ro
      - ./decision_logs:/app/decision_logs
      - ./prompts:/app/prompts
      - ./secrets:/app/secrets
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=${NOFX_TIMEZONE:-Asia/Shanghai}
      - AI_MAX_TOKENS=4000
      - DATA_ENCRYPTION_KEY=${DATA_ENCRYPTION_KEY}
      - JWT_SECRET=${JWT_SECRET:-default_jwt_secret_for_testing}
      # AI Model Configuration
      - CUSTOM_AI_ENDPOINT=${CUSTOM_AI_ENDPOINT:-https://openrouter.ai/api/v1#}
      - CUSTOM_AI_API_KEY=${CUSTOM_AI_API_KEY}
      - CUSTOM_AI_MODEL=${CUSTOM_AI_MODEL:-anthropic/claude-3.5-sonnet}
      # Binance Exchange
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_SECRET_KEY=${BINANCE_SECRET_KEY}
      - BINANCE_TESTNET=${BINANCE_TESTNET:-false}
      - BINANCE_FUTURES=${BINANCE_FUTURES:-true}
      - BTC_ETH_LEVERAGE=${BTC_ETH_LEVERAGE:-5}
      - ALTCOIN_LEVERAGE=${ALTCOIN_LEVERAGE:-5}
      # Risk Management
      - MAX_DAILY_LOSS=${MAX_DAILY_LOSS:-10.0}
      - MAX_DRAWDOWN=${MAX_DRAWDOWN:-20.0}
      - STOP_TRADING_MINUTES=${STOP_TRADING_MINUTES:-60}
      # Default Coins
      - USE_DEFAULT_COINS=${USE_DEFAULT_COINS:-true}
      - DEFAULT_COINS=${DEFAULT_COINS:-BTCUSDT,ETHUSDT,SOLUSDT,BNBUSDT,XRPUSDT,DOGEUSDT,ADAUSDT,HYPEUSDT}
      # Notifications
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      # System
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30}
      - HEALTH_CHECK_TIMEOUT=${HEALTH_CHECK_TIMEOUT:-10}
      - API_TIMEOUT=${API_TIMEOUT:-30s}
      - WEBSOCKET_TIMEOUT=${WEBSOCKET_TIMEOUT:-60s}
    networks:
      - nofx-network
      - dokploy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      # Traefik é…ç½® - Dokploy ä¼šè‡ªåŠ¨ç”Ÿæˆ
      - "traefik.enable=true"
      - "traefik.http.routers.nofx.rule=Host(\`${BACKEND_DOMAIN:-backend.yourdomain.com}\`)"
      - "traefik.http.routers.nofx.entrypoints=websecure"
      - "traefik.http.routers.nofx.tls.certresolver=letsencrypt"
      - "traefik.http.services.nofx.loadbalancer.server.port=8080"

  # ============================================================
  # Frontend æœåŠ¡ï¼šé™æ€æ–‡ä»¶ï¼ˆæ—  Nginx proxyï¼‰
  # ============================================================
  nofx-frontend:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.frontend
    container_name: nofx-frontend
    restart: unless-stopped
    # NO PORTS - Dokploy handles this via Traefik
    # ports:
    #   - "${NOFX_FRONTEND_PORT:-3000}:80"
    volumes:
      - ./nginx/nginx.static.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/localtime:/etc/localtime:ro
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8080/api}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:8080/ws}
      - NEXT_PUBLIC_DOMAIN=${NEXT_PUBLIC_DOMAIN:-localhost}
    networks:
      - nofx-network
      - dokploy-network
    depends_on:
      - nofx
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nofx-frontend.rule=Host(\`${FRONTEND_DOMAIN:-app.yourdomain.com}\`)"
      - "traefik.http.routers.nofx-frontend.entrypoints=websecure"
      - "traefik.http.routers.nofx-frontend.tls.certresolver=letsencrypt"

networks:
  nofx-network:
    driver: bridge
  dokploy-network:
    external: true  # è¿žæŽ¥åˆ° Dokploy ç½‘ç»œ

volumes:
  # Redis ç¼“å­˜ï¼ˆå¯é€‰ï¼Œç”¨äºŽä¼šè¯å…±äº«ï¼‰
  redis_data:
    driver: local
